<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <link rel="stylesheet" href="/navbar.css">
    <link rel="stylesheet" href="/chat.css">
</head>
<body>
  <nav>
      <div id="selectEventDiv">
          <button class="navbutton" id="nbaButton">NBA</button>
          <button class="navbutton" id="mlbButton">MLB</button>
          <button class="navbutton" id="nhlButton">NHL</button>
          <button class="navbutton" id="nflButton">NFL</button>
      </div>

      <div id="authbox">
          <button id="signInButton" onclick="window.location = '/login'" class="navbutton">Sign In</button>
          <div id="separator"></div>
          <button id="registerButton" onclick="window.location = '/register'" class="navbutton">Register</button>
      </div>
  </nav>

    <div id="chatArea">
    <div id="chatBox">
      <% for(message of messages) { %>
            <div class="messageDiv">
            <span class="displayName"><%= message.displayName %></span>
            <span class="content"><%= message.content %></span>
            <span class="time"><%= helper.formatDate(message.time) %></span>
            </div>
      <% } %>
    </div>
    <div id="inputDiv">
    <input type="text" id="messageInput"/>
    <button id="submitMessageButton">SEND</button>
  </div>
</div>

    <script src="https://cdn.socket.io/3.1.3/socket.io.min.js" integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh" crossorigin="anonymous"></script>
<script>
    var chatbox = document.getElementById("chatBox");
    chatbox.scrollTop = chatbox.scrollHeight;
    var socket = io();

    var messageBox = document.getElementById('chatBox');
    var submitButton = document.getElementById('submitMessageButton');
    var messageInput = document.getElementById('messageInput');

    submitButton.addEventListener('click', function(e) {
      e.preventDefault();
      if (messageInput.value) {
        // get uuser id and displayname from session
        let msg = {userId: 1, displayName:"Lol", content: messageInput.value, time: getCurrentDate(), eventId:"<%= eventId %>"}
        socket.emit('chat message', msg);
        messageInput.value = '';

        fetch(`/write`, {
            method: "post",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(msg)
            });
      }
    });

    socket.on('chat message', function(msg) {
      var formatDate = <%- helper.formatDate %>;
      var time = formatDate(msg.time);
      // var time = formatDate(msg.time)
      messageBox.innerHTML = `<div class='messageDiv'>
      <span class="displayName">${msg.displayName}</span>
      <span class="content">${msg.content}</span>
      <span class="time">${time}</span>
      </div>` + messageBox.innerHTML;
      messageBox.scrollTop = messageBox.scrollHeight;
    });

    function getCurrentDate(){
        var date = new Date();
        return date.getFullYear() + "-" + ("0" + (date.getMonth() + 1)).slice(-2) + "-" +("0" + date.getDate()).slice(-2) + " " + ("0" + date.getHours() ).slice(-2) + ":"+ ("0" + date.getMinutes()).slice(-2) + ":" +("0" + date.getSeconds()).slice(-2);
    }
  </script>
</body>
</html>
